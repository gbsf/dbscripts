#!/bin/bash

. "$(dirname $0)/config"
. "$(dirname $0)/db-functions"

if (( $# < 3 )); then
	msg "usage: ${0##*/} <repo-from> <repo-to> <arch> <pkgname> ..."
	exit 1
fi

args=(${@})
repo_from="${args[0]}"
repo_to="${args[1]}"
arch="${args[2]}"
pkgs=("${args[@]:3}")
ftppath_from="${FTP_BASE}/${repo_from}/os/"
ftppath_to="${FTP_BASE}/${repo_to}/os/"

if ! check_repo_permission $repo_to || ! check_repo_permission $repo_from; then
	die "You don't have permission to move packages from %s to %s" "$repo_from" "$repo_to"
fi

# TODO: this might lock too much (architectures)
for pkgarch in ${ARCHES[@]}; do
	repo_lock ${repo_to} ${pkgarch} || exit 1
	repo_lock ${repo_from} ${pkgarch} || exit 1
done

msg "Moving packages from [%s] to [%s]..." "$repo_from" "$repo_to"

# TODO: resolve pkgname to pkgfile for db_add
#       and actually make this script callable
#       with a pkgname rather than a pkgfile
for pkg in "${pkgs[@]}"; do
	pkgname=$(getpkgname "$FTP_BASE/$PKGPOOL/$pkg")
	arch_db_add "${repo_to}" "$arch" "$pkg"
	arch_db_remove "${repo_from}" "$arch" "$pkgname"
done

arch_history_commit "db-move: ${pkgs[@]}"

for pkgarch in ${ARCHES[@]}; do
	repo_unlock ${repo_from} ${pkgarch}
	repo_unlock ${repo_to} ${pkgarch}
done
